# Setting up Elasticsearch and Kibana

Clone this repo to the location you want to run Elasticsearch and Kibana

1. Bring up the service:

   ```console
   $ cd backend
   $ docker compose up -d
   ```

2. Auto-generation of the password for the `elastic` user typically fails with the Docker compose setup, so we need to manually reset the password:

    ```console
    $ docker compose exec elasticsearch /usr/share/elasticsearch/bin/elasticsearch-reset-password -u elastic
    This tool will reset the password of the [elastic] user to an autogenerated value.
    The password will be printed in the console.
    Please confirm that you would like to continue [y/N] y

    Password for the [elastic] user successfully reset.
    New value: pd...
    ```

   If it asks for you to confirm, type `y` and hit enter.

   Save this as `ELASTIC_PASSWORD` in the [`.env`](../.env) file.

3. Get the fingerprint of the certificate

   ```console
   $ docker compose exec elasticsearch openssl x509 -fingerprint -sha256 -noout -in config/certs/http_ca.crt | cut -d'=' -f2
   ```

   Save this as `ELASTIC_FINGERPRINT` in the [`.env`](../.env) file.

3. Generate a Kibana access token 

   ```console
   $ docker compose exec elasticsearch /usr/share/elasticsearch/bin/elasticsearch-create-enrollment-token -s kibana
   ```
   
4. Go to http://localhost:5601 and paste in the enrollment token.

5. You'll be prompted for a verification code, which you can get via (Note in last test this wasn't necessary)


   ```console
   $ docker compose exec kibana bin/kibana-verification-code
   ```

6. Log into Kibana with username `elastic` and the password from step 2

## Loading sample data into Elasticsearch
<!-- TODO: add instructions for loading our small set of sample data -->

# Running the backend

1. Install modules:

    ```console
    $ npm i
    ```

2. To run:

    ```console
    $ npm run dev
    ```

3. Where to edit? Look at [`index.js`](./index.js) for the main entry point.

# Testing

## VSCode testing elastic

1. Install "Elastic Search for VScode"

2. Create a file `query.es` (or any file ending in `.es`) 

3. You can then run the queries from with VScode

## VScode httpBook

1. Install "httpBook" extension

2. Create a file `test.http` 

3. Add various test rest commands, like below

    ```
    POST http://localhost:3000/api/search/app_id HTTP/1.1

    content-type: application/json
    {
        "app_id": "1542367205"    
    }
    ```

4. Run them and see results. 
